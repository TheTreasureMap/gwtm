{% block alert_viz %}
<head>
<style>

.slidecontainer {
  width: 100%;
}

.slider {
  -webkit-appearance: none;
  width: 100%;
  height: 25px;
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider:hover {
  opacity: 1;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 25px;
  height: 25px;
  background: #4CAF50;
  cursor: pointer;
}

.slider::-moz-range-thumb {
  width: 25px;
  height: 25px;
  background: #4CAF50;
  cursor: pointer;
}

.alerttypeactive {
  cursor: auto;
  color: black;
  background-color:darkgray;
  outline: darkgray;
  border: darkgray;
}

.alerttypeinactive {
  cursor: pointer;
}

div.constrained {
  overflow: auto;
  height: 100px;
}

.scroll-section {
  max-height: 100px;
  overflow-y: auto;
}

.overlaycolorbox {
  display: inline-block;
  height: 13px;
  width: 13px;
  background-color: white;
}

.markercolordot {
  height: 13px;
  width: 13px;
  background-color: white;
  border-radius: 50%;
  display: inline-block;
  margin-bottom: -2px;
}

.loadingtext {
  font-style: italic;
  color: darkgrey;
}

text.info{
    position:relative; /*this is the key*/
    z-index:24; 
    /*background-color:#ccc;
    color:#000;*/
    text-decoration:none
}
text.info:hover{
    z-index:25; 
    cursor: help;
    /*background-color:#ff0*/
}
text.info span{
    display: none
}
text.info:hover span{ /*the span will display just on :hover state*/
    cursor: help;
    display:block;
    position:absolute;
    top:2em; left:0em; 
    width:15em;
    border:1px solid rgb(33, 109, 207);
    background-color:rgb(33, 109, 207); 
    color: white;
    font-size: 10pt;
    text-align: center;
    border-radius: 18px;
  }
</style>
</head>


<!-- aladin v3... breaks it all
<link href="https://aladin.u-strasbg.fr/AladinLite/css/style.css" rel="stylesheet" />
<script type="text/javascript" src="https://aladin.u-strasbg.fr/AladinLite/api/v3/latest/aladin.js" charset="utf-8"></script>
-->
<body>
  <input type="hidden" id="hidden_alertid" value="{{ form.selected_alert_info.id }}">

  <ul id='alerttypenav' class="nav nav-tabs">
    {% for al in form.alert_type_tabs if al['type']!= "Retraction" %}
      {% if al['type'] == form.alert_type %}
        <!-- <li class="active"><a href="/{{ form.page }}?graceids={{ form.graceid }}&pointing_status={{ form.status }}&alert_type={{ al['type'] }}">{{ al['type'] }} <br> {{al['timesent']}}</a></li>-->
        <li class="nav-item" style="cursor: pointer;"><a class="nav-link active" id="{{ al['urlid']}}">{{ al['type'] }}<br>{{al['timesent']}}</a></li>
      {% else %}
        <li class="nav-item" style="cursor: pointer;"><a class="nav-link" id="{{ al['urlid']}}">{{ al['type'] }}<br>{{al['timesent']}}</a></li>
      {% endif %}
    {% endfor %}
  </ul>

  <div class='row'>
    <!-- The Aladin Viz -->
    <div class='column'style="float:left; width: 70%; height:6.66in;">
      <div id="aladin-lite-div" style="position: relative; width: 100%; height:100%;"></div>
    </div>
    <!-- Viz interaction column -->
    <div class="column" style="float: right; width: 30%; padding-left: 2%;">
      <div class="row">
        <h3> Follow-Up </h3>
      </div>
      <!-- Instrument block buttons and div -->
      <div class="btn-group">
        <button disabled id='alert_inst_coll' onclick='changeCollapseButtonText(this.id)' type="button" class="btn btn-primary btn-sm alert_coll down-triangle my-1" data-toggle='collapse' data-target='#alert_instruments_div'></button> 
        <button disabled id='alert_hideshow_inst' onclick='hideShowAll(this.id)' type="button" class="btn btn-primary btn-sm my-1">Hide</button>
        <h4 style="display: inline-block;" id='instrumentsHeader' class="loadingtext">...Loading...</h4> 
      </div>
      <div class="row">
        <div class="collapse in scroll-section inst_coll" id="alert_instruments_div"></div>
      </div>
      <!-- GRB coverage block buttons and div -->
      <div class="btn-group">
        <button id='alert_grb_coll' onclick='changeCollapseButtonText(this.id)' type="button" class="btn btn-primary btn-sm alert_coll down-triangle my-1" data-toggle='collapse' data-target='#alert_grbcov_div'></button>
        <button id='alert_hideshow_grb' onclick='hideShowAll(this.id)' type="button" class="btn btn-primary btn-sm my-1">Show</button>
        <h4 style="display: inline-block;">GRB Coverage</h4> 
      </div>
      <div class="row">
        <div class="collapse in grb_coll" id="alert_grbcov_div"></div>
      </div>
      <div class="row">
        <h3> Sources </h3>
      </div>
      <!-- Galaxies block buttons and div -->
      <div class="btn-group">
        <button id='alert_gal_coll' onclick='changeCollapseButtonText(this.id)' type="button" class="btn btn-primary btn-sm alert_coll down-triangle my-1" data-toggle='collapse' data-target='#alert_gal_div'></button> 
        <button type="button" id="alert_event_galaxies" class="btn btn-primary btn-sm my-1">Get</button>
        <h4 style="display: inline-block;">Galaxies</h4> 
      </div>
      <div class="row">
        <div class="collapse in gal_coll" id='alert_gal_div'></div>
      </div>
      <!-- XRT sources block buttons and div -->
      <!-- <div class="btn-group">
        <button id='alert_xrt_coll' onclick='changeCollapseButtonText(this.id)' type="button" class="btn btn-primary btn-sm alert_coll down-triangle my-1" data-toggle='collapse' data-target='#alert_scimmadiv'></button>
        <button type="button" id="alert_scimma_xrt" class="btn btn-primary btn-sm my-1">Get</button>
        <h4 style="display: inline-block;">XRT Sources</h4> 
      </div>
      <div class="row">
        <div class="collapse in xrt_coll" id ="alert_scimmadiv"></div>
      </div> -->
      {% if form.has_icecube %}
        <!-- ICECUBE block buttons and div -->
        <div class="btn-group">
          <button id='alert_icecube_coll' onclick='changeCollapseButtonText(this.id)' type="button" class="btn btn-primary btn-sm alert_coll down-triangle my-1" data-toggle='collapse' data-target='#alert_icecubediv'></button>
          <button type="button" id="alert_icecube_notice" class="btn btn-primary btn-sm my-1">Get</button>
          <h4 style="display: inline-block;">ICECUBE Notice</h4> 
        </div>
        <div class="row">
          <div class="collapse in icecube_coll" id ="alert_icecubediv"></div>
        </div>
      {% endif %}
      {% if form.has_candidate %}
        <!-- Candidate block buttons and div -->
        <div class="btn-group">
          <button id='alert_candidate_coll' onclick='changeCollapseButtonText(this.id)' type="button" class="btn btn-primary btn-sm alert_coll down-triangle my-1" data-toggle='collapse' data-target='#alert_candidatediv'></button>
          <button type="button" id="alert_candidate" class="btn btn-primary btn-sm my-1">Get</button>
          <h4 style="display: inline-block;">Candidates</h4> 
        </div>
        <div class="row">
          <div class="collapse in candidate_coll" id ="alert_candidatediv"></div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- pointing status selection and timeslider-->
  <div>
    <p><b>Pointing Status</b> 
      <select class='selectpicker' name=pointing_status id=pointing_status>
        {% for a in form.pointing_status %}
          {% if a['value'] == form.status %}
            <option selected='True' value={{ a['value'] }}>{{ a['name'] }}</option>
          {% else %}
            <option value={{ a['value'] }}>{{ a['name'] }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </p>

    <p>
      <label for="amount">Date range (days since Time of Signal):</label>
      <input type="text" id="amount" style="border: 0; color: #f6931f; font-weight: bold;" size="100"/>
    </p>
     
    <div id="slider-range"></div>
    <br>
  </div>

  <!-- GW Alert Information -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6">
        <table class="table">
          <thead>
            <tr>
              <th>Information</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr>
            {% if form.selected_alert_info.group != 'None' and form.selected_alert_info.group != '' and form.selected_alert_info.group != None %}
            <tr class="alert-info">
              <td>Group</td>
              <td id='alert_group'>{{ form.selected_alert_info.group }}</td>
            </tr>
            {% endif %}
            <tr class="alert-info">
              <td>Detectors</td>
              <td id='alert_detectors'>{{ form.selected_alert_info.detectors }}</td>
            </tr>
            <tr class="alert-info">
              <td>Time of Signal</td>
              <td id='alert_time_of_signal'>{{ form.selected_alert_info.time_of_signal }} UTC</td>
            </tr>
            <tr class="alert-info">
              <td>Time Sent</td>
              <td id='alert_timesent'>{{ form.selected_alert_info.timesent }} UTC</td>
            </tr>
            <tr class="alert-info">
              <td>False Alarm Rate</td>
              <td id='alert_human_far'>once per {{form.selected_alert_info.human_far}} {{form.selected_alert_info.human_far_unit}}</td>
            </tr>
            <tr class="alert-info">
              <td>50% Area</td>
              <td id='alert_area_50'>{{ form.selected_alert_info.area_50}} deg<sup>2</sup></td>
            </tr>
            <tr class="alert-info">
              <td>90% Area</td>
              <td id='alert_area_90'>{{ form.selected_alert_info.area_90}} deg<sup>2</sup></td>
            </tr>
            {% if form.selected_alert_info.group != 'Burst' %}
            <tr class="alert-info">
              <td>Distance</td>
              <td id='alert_distance_plus_error'>{{ form.distance }} +/- {{ form.distance_error }} Mpc</td>
            </tr>
            {% else %}
            <tr class="alert-info">
              <td>Central Frequency</td>
              <td id='alert_centralfreq'>{{form.selected_alert_info.centralfreq}} Hz</td>
            </tr>
            <tr class="alert-info">
              <td>Duration</td>
              <td id='alert_duration'>{{form.selected_alert_info.duration}} seconds</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
        <table class="table ext_coinc" hidden>
          <thead>
            <tr>
              <th>External Coincidence Info</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr class="alert-info ext_coinc">
              <td>GCN Notice ID</td>
              <td id="alert_gcn_notice_id"></td>
            </tr>
            <!-- <tr class="alert-info ext_coinc">
              <td>Ivorn</td>
              <td id="alert_ivorn"></td>
            </tr> -->
            <tr class="alert-info ext_coinc">
              <td>ExtCoinc Observatory</td>
              <td id="alert_ext_coinc_observatory"></td>
            </tr>
            <tr class="alert-info ext_coinc">
              <td>ExtCoinc Search</td>
              <td id="alert_ext_coinc_search"></td>
            </tr>
            <tr class="alert-info ext_coinc">
              <td>Time Difference (s)</td>
              <td id="alert_time_difference"></td>
            </tr>
            <tr class="alert-info ext_coinc">
              <td>Time Coincidence FAR</td>
              <td id="alert_time_coincidence_far"></td>
            </tr>
            <tr class="alert-info ext_coinc">
              <td>Time-Sky position Coincidence FAR</td>
              <td id="alert_time_sky_position_coincidence_far"></td>
            </tr>
          </tbody>
        </table>
      </div>
      {% if form.selected_alert_info.group != 'Burst' %}
      <div class="col-sm-6">
        <table class="table">
          <thead>
            <tr>
              <th>Classification (CBC Only)</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr class="alert-info">
              <td>BNS</td>
              <td id='alert_prob_bns'>{{ form.selected_alert_info.prob_bns }}</td>
            </tr>
            <tr class="alert-info">
              <td>NSBH</td>
              <td id='alert_prob_nsbh'>{{ form.selected_alert_info.prob_nsbh }}</td>
            </tr>
            <tr class="alert-info">
              <td>Mass Gap</td>
              <td id='alert_prob_gap'>{{ form.selected_alert_info.prob_gap }}</td>
            </tr>
            <tr class="alert-info">
              <td>BBH</td>
              <td id='alert_prob_bbh'>{{ form.selected_alert_info.prob_bbh }}</td>
            </tr>
            <tr class="alert-info">
              <td>Terrestrial</td>
              <td id='alert_prob_terrestrial'>{{ form.selected_alert_info.prob_terrestrial }}</td>
            </tr>
            <tr class="alert-info">
              <td>Has NS</td>
              <td id='alert_prob_hasns'>{{ form.selected_alert_info.prob_hasns }}</td>
            </tr>
            <tr class="alert-info">
              <td>Has Remnant</td>
              <td id='alert_prob_hasremenant'>{{ form.selected_alert_info.prob_hasremenant }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>

<!-- BEGIN: coverage calculator -->
<div class = "container-fluid">
  <center><h3>Coverage Calculator</h3></center>

  <br>

  <i> 
    Calculate the coverage of the GW localization over time, 
    with choices to limit the coverage calculation to particular sets of instruments, 
    wavelengths, or depth. All fields are optional, but cuts on depths must have an associated unit. 
    If an empty form is submitted, the total reported coverage regardless of depth or band is computed. 
    Once a HEALPIX pixel has been first covered, it is marked as done, to avoid double counting probability 
    when the same field is covered multiple times. After clicking Calculate, be patient, it may take up to 2 minutes 
    to fully compute the coverage profile.
    You may also click Renorm Skymap to remove the selected pointings from the GW localization contours in the map above. 
  </i>
  <p style="color: red; font-size: small;">
    Disclaimer: The DECam Footprint currently breaks in the calculator. We are temporarily approximating its coverage as a circle with 1 deg radius.
  </p>

  <br>

  <!-- Coverage plot placeholder -->
  <div id ="coveragediv"></div>
  
  <!-- Coverage plot input parameters-->
  <div>
    <b>Instrument</b>
    <select class="selectpicker" multiple data-live-search="true" name=inst_cov id=inst_cov>
        {% for a in form.inst_cov %}
            <option value={{ a['value'] }}>{{ a['name'] }}</option>
        {% endfor %}
    </select>

    <b>Depth</b>
    <input type="text" size=7 name=depth_cov id=depth_cov oninput="this.value=this.value.replace(/(?![0-9,.])./gmi,'')">

    <b>Depth Unit</b>
    <select class="selectpicker" multiple data-max-options="1" name=depth_unit id=depth_unit>
        {% for a in form.depth_unit %}
          {% if 'erg' in a['name'] %}
          <option value={{ a['value'] }}>FLUX erg cm^-2 s^-1</option>
          {% else %}
          <option value={{ a['value'] }}>{{ a['name'] }}</option>
          {% endif %}
        {% endfor %}
    </select>
    <b><text class='info'>Approximate
      <span>
        For footprints with multiple ccd's this will approximate the calculator's input by using a simplified instrument footprint without chip-gaps. It is substantially faster, but does introduce a level of uncertainty in the resulting area and probability.
      </span>
    </text></b>
    <select class="selectpicker" multiple data-max-options="1"  name=approx_cov id=approx_cov>
      <option value=1 selected>Yes</option>
      <option value=0>No</option>
    </select>

    <br>
    <b>Band</b>
    <select class="selectpicker" style="max-width: 60px;" multiple data-live-search="true" name=band_cov id=band_cov onchange="spectral_range_from_bandpasses()">
        {% for a in form.band_cov %}
          <option value={{ a['value'] }}>{{ a['name'] }}</option>
        {% endfor %}
    </select>
    <b><text class='info'>Spectral Range
      <span>
        Filter pointings based on their wavelength, energy, or frequency range
      </span>
    </text></b>
    <b>Type: </b>
    <select style="max-width: 60px;" class="selectpicker" name=spectral_range_type id=spectral_range_type onchange="spectral_units_dynammic_selector(this.value)">
      <option value='wavelength' selected>Wavelength</option>
      <option value='energy'>Energy</option>
      <option value='frequency'>Frequency</option>
    </select>
      <b>Range: </b><input size="10" type="text" oninput="this.value=this.value.replace(/(?![0-9,.])./gmi,'')" id="spectral_range_low" name="spectral_range_low"> -
      <input size="10" type="text" oninput="this.value=this.value.replace(/(?![0-9,.])./gmi,'')" id="spectral_range_high" name="spectral_range_high">
    <b>Unit</b>
    <select id=spectral_range_unit onchange="spectral_range_from_bandpasses()">

    </select>
  </div>
  

  <br><br>
  <div style="display: flex; justify-content: center; gap: 10px; margin: 0 auto;">
    <input type="button" id="calculate" value="Calculate" class="btn btn-primary"/>
    <input type="button" id="renorm-skymap" value="Renorm Skymap" class="btn btn-primary"/>
  </div>
  <!input type="button" id="calculate" value="Calculate" class="btn btn-primary" style="display: block; margin: 0 auto;"/>
  <!input type="button" id="renorm-skymap" value="Renorm Skymap" class="btn btn-secondary"/>
</div>
    
<!-- Creation of Aladin Lite instance with initial parameters -->
<script type='text/javascript'>

  var inst_overlays = {}
  var marker_list = {}
  var galaxy_cats = {}
  var target_init = "{{ form.avgra }} {{ form.avgdec }}"
  var detection_overlays = JSON.parse('{{ detection_overlays | tojson }}');
  var GRBoverlays = JSON.parse('{{ GRBoverlays | tojson }}');

  var sun_ra = '{{ form.selected_alert_info.sun_ra }}';
  var sun_dec = '{{ form.selected_alert_info.sun_dec }}';
  var moon_ra = '{{ form.selected_alert_info.moon_ra }}';
  var moon_dec = '{{ form.selected_alert_info.moon_dec }}';

  var slider_min = new Number('{{ form.mintime }}');
  var slider_max = new Number('{{ form.maxtime }}');
  var slider_step = new Number('{{ form.step }}');
  var slider_vals = [(slider_min), (slider_max)];

</script>
<script type='text/javascript' src="{{ url_for('static',filename='js/alert_aladin.js') }}"></script>
<script type='text/javascript'>
  var data = {
    detection_overlays: detection_overlays,
    inst_overlays: inst_overlays,
    GRBoverlays: GRBoverlays,
    target_init: target_init,
    sun_ra: sun_ra,
    sun_dec: sun_dec,
    moon_ra: moon_ra,
    moon_dec: moon_dec,
  }
  var d = gwtmAladinInit(data)
  data.aladin = d.aladin
  var aladin = d.aladin
  var detectionoverlaylist = d.detectionoverlaylist 
  var grboverlaylist = d.grboverlaylist
  var instoverlaylist = {}
  var set_aladin_markerlist = {} 


  //This asynchronously queries for the instrument footprints
  //Page load time saver.
  window.onload = function(){
    $('#instrumentsHeader').text('...Loading...')
    spectral_units_dynammic_selector('wavelength')
    $.ajax(
      {
        url: '/ajax_alertinstruments_footprints',
        data: 'graceid={{ form.graceid }}&tos_mjd={{ form.tos_mjd }}',
        async: true
      }
    ).done( function(payload){
      aladin.removeLayers()
      data.inst_overlays = payload
      aladin_drawInstHTML(data.inst_overlays, 'alert_instruments_div')
      instoverlaylist = aladin_setContours(aladin, payload)
      detectionoverlaylist = aladin_setContours(aladin, detection_overlays)
      aladin.setFov(200.0)
      aladin.view.requestRedraw();

      $('#instrumentsHeader').text('Instruments')
      $('#instrumentsHeader').removeClass('loadingtext')
      $('#alert_inst_coll').prop('disabled', false); 
      $('#alert_hideshow_inst').prop('disabled', false);
    });
  }
</script>
<!-- Page Interaction JS -->
<script>

  //twistyyyyy -> changes collapsible stuff
  function changeCollapseButtonText(clicked_id){
    var button = document.getElementById(clicked_id);
    
    if (button.classList.contains('right-triangle')) { 
      button.classList.replace('right-triangle', 'down-triangle')
    }
    else {
      button.classList.replace('down-triangle', 'right-triangle')
    }
  }

  //Toggles the instrument and GRB overlays
  function hideShowAll(clicked_id) {
    var button = document.getElementById(clicked_id);
    toShow = (button.innerHTML == 'Show')
    if (clicked_id == 'alert_hideshow_inst') {
      aladin_overlayToggleAll(instoverlaylist, toShow)
      $('.inst_coll input:checkbox').prop('checked', toShow)
    }
    if (clicked_id == 'alert_hideshow_grb') {
      aladin_mocToggleAll(grboverlaylist, toShow)
      $('.grb_coll input:checkbox').prop('checked', toShow)
    }
    if (toShow) { button.innerHTML = 'Hide'}
    else { button.innerHTML = 'Show' }
  }

  function spectral_units_dynammic_selector(spectral_type) {
    var spectral_type_units = JSON.parse('{{ form.spectral_type_units | tojson}}');
    var type_units = spectral_type_units[spectral_type]
    var unitselect = document.querySelector('#spectral_range_unit')
    unitselect.options.length = 0

    for (var k=0 ; k<type_units.length; k++) {
      var selected = false
      if (spectral_type == 'wavelength' && type_units[k] == 'angstrom') { selected = true}
      if (spectral_type == 'energy' && type_units[k] == 'keV') { selected = true}
      if (spectral_type == 'frequency' && type_units[k] == 'kHz') { selected = true}

      var optiontest = document.createElement('option')
      optiontest.selected = selected
      optiontest.value = type_units[k]
      optiontest.text = type_units[k]
      unitselect.add(optiontest)
    }
    spectral_range_from_bandpasses()
  }

  function spectral_range_from_bandpasses() {
      var band_cov = $('#band_cov').val()
      var spectral_type = $('#spectral_range_type').val()
      var spectral_unit = $('#spectral_range_unit').val()
      var spectral_range_low = $('#spectral_range_low').val()
      var spectral_range_high = $('#spectral_range_high').val()

      $.ajax(
          {
              url: '/ajax_update_spectral_range_from_selected_bands',
              data: 'band_cov='+band_cov+'&spectral_type='+spectral_type+'&spectral_unit='+spectral_unit+'&spec_range_low='+spectral_range_low+'&spec_range_high='+spectral_range_high
          }
        ).done(function (reply) 
          {
            $('#spectral_range_low').val(reply['total_min'])
            $('#spectral_range_high').val(reply['total_max'])
          }
        )
  }

  //Listens to clicks in the respective <div>'s
  //  the follow-ups remove clicked overlays
  //  the sources interactively animate the vizualization to the source
  $(document).ready( function() {
    $('#alert_instruments_div').click(function(event) {
      if (event.target.id != '') { 
        var boxes = $('.inst_coll input:checkbox');
        var checkedBoxes = $('.inst_coll input:checked');
        var button = document.getElementById('alert_hideshow_inst');
        if (boxes.length == checkedBoxes.length) { button.innerHTML = 'Hide'}
        if (checkedBoxes.length == 0) { button.innerHTML = 'Show'}
        aladin_overlayToggleOne(event.target, instoverlaylist)
      }
    })
    $('#alert_grbcov_div').click(function(event) {
      if (event.target.id != '') { 
        var boxes = $('.grb_coll input:checkbox');
        var checkedBoxes = $('.grb_coll input:checked');
        var button = document.getElementById('alert_hideshow_grb');
        if (boxes.length == checkedBoxes.length) { button.innerHTML = 'Hide'}
        if (checkedBoxes.length == 0) { button.innerHTML = 'Show'}
        aladin_mocToggleOne(event.target, grboverlaylist)
      }
    })
    $('#alert_gal_div').click(function(event) {
      if (event.target.id.includes('marker_group_')) {
        var boxes = $('.gal_coll input:checkbox');
        var checkedBoxes = $('.gal_coll input:checked');
        var button = document.getElementById('alert_event_galaxies');
        if (boxes.length == checkedBoxes.length) { button.innerHTML = 'Hide'}
        if (checkedBoxes.length == 0) { button.innerHTML = 'Show'}
        aladin_markerToggleOne(set_aladin_markerlist['alert_gal'], event.target)
      }
      else if (event.target.id != '') {
        aladin_animateToMarker(event.target, marker_list['alert_gal'])
      }
    })
    $('#alert_scimmadiv').click(function(event) {
      if (event.target.id.includes('marker_group_')) {
        var boxes = $('.xrt_coll input:checkbox');
        var checkedBoxes = $('.xrt_coll input:checked');
        var button = document.getElementById('alert_scimma_xrt');
        if (boxes.length == checkedBoxes.length) { button.innerHTML = 'Hide'}
        if (checkedBoxes.length == 0) { button.innerHTML = 'Show'}
        aladin_markerToggleOne(set_aladin_markerlist['alert_xrt'], event.target)
      }
      else if (event.target.id != '') {
        aladin_animateToMarker(event.target, marker_list['alert_xrt'])
      }
    })
    $('#alert_icecubediv').click(function(event) {
      if (event.target.id.includes('marker_group_')) {
        var boxes = $('.icecube_coll input:checkbox');
        var checkedBoxes = $('.icecube_coll input:checked');
        var button = document.getElementById('alert_icecube_notice');
        if (boxes.length == checkedBoxes.length) { button.innerHTML = 'Hide'}
        if (checkedBoxes.length == 0) { button.innerHTML = 'Show'}
        aladin_markerToggleOne(set_aladin_markerlist['alert_icecube'], event.target)
      }
      else if (event.target.id != '') {
        aladin_animateToMarker(event.target, marker_list['alert_icecube'])
      }
    })
    $('#alert_candidatediv').click(function(event) {
      if (event.target.id.includes('marker_group_')) {
        var boxes = $('.candidate_coll input:checkbox');
        var checkedBoxes = $('.candidate_coll input:checked');
        var button = document.getElementById('alert_candidate');
        if (boxes.length == checkedBoxes.length) { button.innerHTML = 'Hide'}
        if (checkedBoxes.length == 0) { button.innerHTML = 'Show'}
        aladin_markerToggleOne(set_aladin_markerlist['alert_candidate'], event.target)
      }
      else if (event.target.id != '') {
        aladin_animateToMarker(event.target, marker_list['alert_candidate'])
      }
    })
  });

  //redraw with new contour from the alert type tabs
  $(document).ready( function() {
    $('#alerttypenav').click(function(event) {

      if (event.target.id != 'alerttypenav') {
        var actives = document.getElementsByClassName('nav-link active')
        var thisEl = document.getElementById(event.target.id)
        for(i = 0; i<actives.length; i++){
          actives[i].classList.remove('active')
        }
        thisEl.classList.add('active')

        $.ajax(
          {
            url: '/ajax_alerttype',
            data: 'urlid='+thisEl.id
          }
        ).done(function (payload){
          $('#hidden_alertid').val(payload['hidden_alertid']);
          $('#alert_group').text(payload['alert_group']);
          $('#alert_detectors').text(payload['alert_detectors']);
          $('#alert_time_of_signal').text(payload['alert_time_of_signal']);
          $('#alert_timesent').text(payload['alert_timesent']);
          $('#alert_human_far').text(payload['alert_human_far']);
          $('#alert_distance_plus_error').text(payload['alert_distance_plus_error']);
          $('#alert_centralfreq').text(payload['alert_centralfreq']);
          $('#alert_duration').text(payload['alert_duration']);
          $('#alert_prob_bns').text(payload['alert_prob_bns']);
          $('#alert_prob_nsbh').text(payload['alert_prob_nsbh']);
          $('#alert_prob_gap').text(payload['alert_prob_gap']);
          $('#alert_prob_bbh').text(payload['alert_prob_bbh']);
          $('#alert_prob_terrestrial').text(payload['alert_prob_terrestrial']);
          $('#alert_prob_hasns').text(payload['alert_prob_hasns']);
          $('#alert_area_50').html(payload['alert_area_50']);
          $('#alert_area_90').html(payload['alert_area_90']);
          $('#alert_gcn_notice_id').text(payload['alert_gcn_notice_id']);
          $('#alert_ivorn').text(payload['alert_ivorn']);
          $('#alert_ext_coinc_observatory').text(payload['alert_ext_coinc_observatory']);
          $('#alert_ext_coinc_search').text(payload['alert_ext_coinc_search']);
          $('#alert_time_difference').text(payload['alert_time_difference']);
          $('#alert_time_coincidence_far').text(payload['alert_time_coincidence_far']);
          $('#alert_time_sky_position_coincidence_far').text(payload['alert_time_sky_position_coincidence_far']);

          if (payload['selected_alert_type'].includes('ExtCoinc')){
            var extcoincs = document.getElementsByClassName('table ext_coinc')
            for (var k=0 ; k<extcoincs.length; k++) {
              extcoincs[k].removeAttribute("hidden")
            };
          } else {
            var extcoincs = document.getElementsByClassName('table ext_coinc')
            for (var k=0 ; k<extcoincs.length; k++) {
              extcoincs[k].setAttribute("hidden", "")
            };
          }

          aladin.removeLayers()
          data.detection_overlays = payload.detection_overlays;
          d = overlayInit(aladin, data)
          aladin.animateToRaDec(payload.alert_avgra, payload.alert_avgdec, 2);
          detectionoverlaylist = d.detectionoverlaylist
          instoverlaylist = d.instoverlaylist
          grboverlaylist = d.grboverlaylist

          //This should be deleted once markers are encorporated into the gwtmAladinInit
          $('#alert_gal_div').html('');
          var button = document.getElementById('alert_event_galaxies');
          if (button != null) {
              button.innerHTML = 'Get'
          }

          // $('#alert_scimmadiv').html('');
          // var button = document.getElementById('alert_scimma_xrt');
          // button.innerHTML = 'Get'

          $('#alert_candidatediv').html('');
          var button = document.getElementById('alert_candidate');
          if (button != null) {
              button.innerHTML = 'Get'
          }

          $('#alert_icecubediv').html('');
          var button = document.getElementById('alert_icecube_notice');
          if (button != null) {
              button.innerHTML = 'Get'
          }
        })
      }
    })
  })

  //Function that creates the Coverage plot
  $(document).ready( function() {
      $('#calculate').click(function() {
        $('#calculate').prop('disabled', true)
        var btn = $(this).button('loading');
        var inst_cov = $('#inst_cov').val()
        var band_cov = $('#band_cov').val()
        var depth_cov = $('#depth_cov').val()
        var depth_unit = $('#depth_unit').val()
        var approx_cov = $('#approx_cov').val()
        var spectral_type = $('#spectral_range_type').val()
        var spectral_unit = $('#spectral_range_unit').val()
        var spectral_range_low = $('#spectral_range_low').val()
        var spectral_range_high = $('#spectral_range_high').val()

        $.ajax(
          {
              url: '/ajax_coverage_calculator',
              data: 'graceid={{ form.graceid }}&mappathinfo={{ form.mappathinfo }}&inst_cov='+inst_cov+'&band_cov='+band_cov+'&depth_cov='+depth_cov+'&depth_unit='+depth_unit+'&approx_cov='+approx_cov+'&spec_range_type='+spectral_type+'&spec_range_unit='+spectral_unit+'&spec_range_low='+spectral_range_low+'&spec_range_high='+spectral_range_high
          }
        ).done(function (reply) 
          {
            $('#coveragediv').html(reply);
              btn.prop('disabled', false)
              btn.button('reset')
          }
        ).fail(function(jqXHR, textStatus)
          {
            $('#calculate').prop('disabled', false)
            $('#coveragediv').html("<i><font color='red'>Error in Coverage Calculator</font></i>")
            btn.button('reset')
          }
      );
    });
  });

  //Function that renormalizes the skymap
  $(document).ready( function() {
      $('#renorm-skymap').click(function() {
        $('#renorm-skymap').prop('disabled', true)
        var btn = $(this).button('loading');
        var inst_cov = $('#inst_cov').val()
        var band_cov = $('#band_cov').val()
        var depth_cov = $('#depth_cov').val()
        var depth_unit = $('#depth_unit').val()
        var approx_cov = $('#approx_cov').val()
        var spectral_type = $('#spectral_range_type').val()
        var spectral_unit = $('#spectral_range_unit').val()
        var spectral_range_low = $('#spectral_range_low').val()
        var spectral_range_high = $('#spectral_range_high').val()

        $.ajax(
          {
              url: '/ajax_renormalize_skymap',
              data: 'graceid={{ form.graceid }}&mappathinfo={{ form.mappathinfo }}&inst_cov='+inst_cov+'&band_cov='+band_cov+'&depth_cov='+depth_cov+'&depth_unit='+depth_unit+'&approx_cov='+approx_cov+'&spec_range_type='+spectral_type+'&spec_range_unit='+spectral_unit+'&spec_range_low='+spectral_range_low+'&spec_range_high='+spectral_range_high
          }
        ).done(function (reply) 
          {
            $('#renorm-skymap').prop('disabled', false)
            window.location.href = '/alerts?graceids={{ form.graceid }}&normed_path=' + reply;
          }
        ).fail(function(jqXHR, textStatus)
          {
            $('#renorm-skymap').prop('disabled', false)
            $('#coveragediv').html("<i><font color='red'>Error in Renormalize Skymap</font></i>")
            btn.button('reset')
          }
      );
    });
  });
  
  //getting the alert event galaxies
  $(document).ready( function() {
    $('#alert_event_galaxies').click(function() {
      var button = document.getElementById('alert_event_galaxies');
      var alertid = document.getElementById('hidden_alertid').value;
      if (button.innerHTML == 'Get') {
        $('#alert_event_galaxies').prop('disabled', true)
        $.ajax(
        {
            url: '/ajax_event_galaxies',
            data: 'alertid='+alertid
        }
        ).done(function (event_galaxies) {
          $('#alert_event_galaxies').prop('disabled', false)
          if (event_galaxies.length > 0) {
            marker_list['alert_gal'] = event_galaxies
            gal_markerlist = aladin_setMarkers(aladin, event_galaxies)
            aladin_setMarkerHtml(event_galaxies, 'alert_gal_div')
            button.innerHTML = 'Hide'
            set_aladin_markerlist['alert_gal'] = gal_markerlist
          } else {
            var html = "<p>No Results</p>"
            $('#alert_gal_div').html(html);
          }
        });
      }
      else if (button.innerHTML == 'Hide') {
        toShow = button.innerHTML == 'Show'
        aladin_markerToggleAll(set_aladin_markerlist['alert_gal'], toShow)
        button.innerHTML = 'Show'
        $('.gal_coll input:checkbox').prop('checked', toShow)
      }
      else if (button.innerHTML == 'Show') {
        toShow = button.innerHTML == 'Show'
        aladin_markerToggleAll(set_aladin_markerlist['alert_gal'], toShow)
        button.innerHTML = 'Hide'
        $('.gal_coll input:checkbox').prop('checked', toShow)
      }
    });
  });

  //Function that calls the XRT sources and populates them 
  // on the aladin viz. Encorporates hide/show
  $(document).ready( function() {
    $('#alert_scimma_xrt').click(function() {
      var button = document.getElementById('alert_scimma_xrt');
      if (button.innerHTML == 'Get') {
        $('#alert_scimma_xrt').prop('disabled', true)
        $.ajax(
        {
            url: '/ajax_scimma_xrt',
            data: 'graceid={{ form.graceid }}'
        }).done(function (event_xrt_sources) {
          $('#alert_scimma_xrt').prop('disabled', false)
          if (event_xrt_sources.length > 0) {
            marker_list['alert_xrt'] = event_xrt_sources
            var xrt_markerlist = aladin_setMarkers(aladin, event_xrt_sources)
            aladin_setMarkerHtml(event_xrt_sources, 'alert_scimmadiv')
            button.innerHTML = 'Hide'
            set_aladin_markerlist['alert_xrt'] = xrt_markerlist
          } else {
            var html = '<p>No results</p>'
            $('#alert_scimmadiv').html(html);
          }
        });
      }
      else if (button.innerHTML == 'Hide') {
        toShow = button.innerHTML == 'Show'
        aladin_markerToggleAll(set_aladin_markerlist['alert_xrt'], toShow)
        button.innerHTML = 'Show'
        $('.xrt_coll input:checkbox').prop('checked', toShow)
      }
      else if (button.innerHTML == 'Show') {
        toShow = button.innerHTML == 'Show'
        aladin_markerToggleAll(set_aladin_markerlist['alert_xrt'], toShow)
        button.innerHTML = 'Hide'
        $('.xrt_coll input:checkbox').prop('checked', toShow)
      }
    });
  });

  $(document).ready( function() {
    $('#alert_icecube_notice').click(function() {
      var button = document.getElementById('alert_icecube_notice');
      if (button.innerHTML == 'Get') {
        $('#alert_icecube_notice').prop('disabled', true)
        $.ajax(
        {
            url: '/ajax_icecube_notice',
            data: 'graceid={{ form.graceid }}'
        }).done(function (event_icecube_notice) {
          $('#alert_icecube_notice').prop('disabled', false)
          if (event_icecube_notice.length > 0) {
            marker_list['alert_icecube'] = event_icecube_notice
            var icecube_marker_list = aladin_setMarkers(aladin, event_icecube_notice)
            aladin_setMarkerHtml(event_icecube_notice, 'alert_icecubediv')
            button.innerHTML = 'Hide'
            set_aladin_markerlist['alert_icecube'] = icecube_marker_list
          } else {
            var html = '<p>No results</p>'
            $('#alert_icecubediv').html(html);
          }
        });
      }
      else if (button.innerHTML == 'Hide') {
        toShow = button.innerHTML == 'Show'
        aladin_markerToggleAll(set_aladin_markerlist['alert_icecube'], toShow)
        button.innerHTML = 'Show'
        $('.icecube_coll input:checkbox').prop('checked', toShow)
      }
      else if (button.innerHTML == 'Show') {
        toShow = button.innerHTML == 'Show'
        aladin_markerToggleAll(set_aladin_markerlist['alert_icecube'], toShow)
        button.innerHTML = 'Hide'
        $('.icecube_coll input:checkbox').prop('checked', toShow)
      }
    });
  });

  $(document).ready( function() {
    $('#alert_candidate').click(function() {
      var button = document.getElementById('alert_candidate');
      if (button.innerHTML == 'Get') {
        $('#alert_candidate').prop('disabled', true)
        $.ajax(
        {
            url: '/ajax_candidate',
            data: 'graceid={{ form.graceid }}'
        }).done(function (event_candidates) {
          $('#alert_candidate').prop('disabled', false)
          if (event_candidates.length > 0) {
            marker_list['alert_candidate'] = event_candidates
            var candidate_marker_list = aladin_setMarkers(aladin, event_candidates)
            aladin_setMarkerHtml(event_candidates, 'alert_candidatediv')
            button.innerHTML = 'Hide'
            set_aladin_markerlist['alert_candidate'] = candidate_marker_list
          } else {
            var html = '<p>No results</p>'
            $('#alert_candidiatediv').html(html);
          }
        });
      }
      else if (button.innerHTML == 'Hide') {
        toShow = button.innerHTML == 'Show'
        aladin_markerToggleAll(set_aladin_markerlist['alert_candidate'], toShow)
        button.innerHTML = 'Show'
        $('.candidate_coll input:checkbox').prop('checked', toShow)
      }
      else if (button.innerHTML == 'Show') {
        toShow = button.innerHTML == 'Show'
        aladin_markerToggleAll(set_aladin_markerlist['alert_candidate'], toShow)
        button.innerHTML = 'Hide'
        $('.candidate_coll input:checkbox').prop('checked', toShow)
      }
    });
  });

  //redraws the screen when changing pointing status dropdown
  $('#pointing_status').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
    $('#instrumentsHeader').text('...Loading...')
    $('#alert_instruments_div').html('');
    $('#alert_inst_coll').prop('disabled', true); 
    $('#alert_hideshow_inst').prop('disabled', true);

    $.ajax(
      {
        url: '/ajax_alertinstruments_footprints',
        data: 'graceid={{ form.graceid }}&tos_mjd={{ form.tos_mjd }}&pointing_status='+$(this).val(),
        async: true
      }
    ).done( function(payload){
      data.inst_overlays = payload
      aladin.removeLayers()
      d = gwtmAladinInit(data)
      detectionoverlaylist = d.detectionoverlaylist
      instoverlaylist = d.instoverlaylist
      grboverlaylist = d.grboverlaylist
      $('#instrumentsHeader').text('Instruments')
      $('#alert_inst_coll').prop('disabled', false); 
      $('#alert_hideshow_inst').prop('disabled', false);

      var button = document.getElementById('alert_hideshow_inst')
      button.innerHTML = 'Hide'

      //This should be deleted once markers are encorporated into the gwtmAladinInit
      $('#alert_gal_div').html('');
      var button = document.getElementById('alert_event_galaxies');
      if (button != null) {
          button.innerHTML = 'Get'
      }

      // $('#alert_scimmadiv').html('');
      // var button = document.getElementById('alert_scimma_xrt');
      // button.innerHTML = 'Get'

      $('#alert_candidatediv').html('');
      var button = document.getElementById('alert_candidate');
      if (button != null) {
          button.innerHTML = 'Get'
      }

      $('#alert_icecubediv').html('');
      var button = document.getElementById('alert_icecube_notice');
      if (button != null) {
          button.innerHTML = 'Get'
      }
    });
  });
</script>
  </body>
{% endblock %}

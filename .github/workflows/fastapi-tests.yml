name: FastAPI Tests

on:
  push:
    branches: [ master, fastapi, svelte ]
  pull_request:
    branches: [ master, fastapi, svelte ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python for test dependencies
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/requirements.txt
        
    - name: Set up environment variables
      run: |
        echo "DB_USER=treasuremap" >> $GITHUB_ENV
        echo "DB_PWD=treasuremap" >> $GITHUB_ENV
        echo "DB_NAME=treasuremap" >> $GITHUB_ENV
        echo "MAIL_PASSWORD=dummy" >> $GITHUB_ENV
        echo "RECAPTCHA_PUBLIC_KEY=dummy" >> $GITHUB_ENV
        echo "RECAPTCHA_PRIVATE_KEY=dummy" >> $GITHUB_ENV
        echo "ZENODO_ACCESS_KEY=dummy" >> $GITHUB_ENV
        echo "AWS_ACCESS_KEY_ID=dummy" >> $GITHUB_ENV
        echo "AWS_SECRET_ACCESS_KEY=dummy" >> $GITHUB_ENV
        
    - name: Build FastAPI Docker image
      run: |
        docker build -f server/Dockerfile -t gwtm_fastapi:latest .
        
    - name: Start database with Docker Compose
      run: |
        DB_USER=treasuremap DB_PWD=treasuremap DB_NAME=treasuremap docker compose -p gwtm up -d db
        
    - name: Wait for database to be ready
      run: |
        timeout 120 bash -c 'until DB_USER=treasuremap DB_PWD=treasuremap DB_NAME=treasuremap docker compose -p gwtm exec -T db pg_isready -U treasuremap -d treasuremap; do sleep 5; done'
        
    - name: Enable PostGIS extension
      run: |
        DB_USER=treasuremap DB_PWD=treasuremap DB_NAME=treasuremap docker compose -p gwtm exec -T db psql -U treasuremap -d treasuremap -c "CREATE EXTENSION IF NOT EXISTS postgis;"
        
    - name: Initialize database schema with FastAPI models
      run: |
        docker run --rm --network gwtm_default \
          -e DB_USER=treasuremap \
          -e DB_PWD=treasuremap \
          -e DB_NAME=treasuremap \
          -e DB_HOST=db \
          -e DB_PORT=5432 \
          gwtm_fastapi:latest \
          python -c "from server.db.init_db import create_database_tables; create_database_tables()"
        
    - name: Start FastAPI server
      run: |
        docker run -d --name fastapi-server \
          --network gwtm_default \
          -e DB_USER=treasuremap \
          -e DB_PWD=treasuremap \
          -e DB_NAME=treasuremap \
          -e DB_HOST=db \
          -e DB_PORT=5432 \
          -p 8000:8000 \
          gwtm_fastapi:latest
          
    - name: Wait for FastAPI server to be ready
      run: |
        timeout 120 bash -c 'until curl -f http://localhost:8000/health; do echo "Waiting for FastAPI..."; sleep 5; done'
        
    - name: Load test data
      run: |
        DB_USER=treasuremap DB_PWD=treasuremap DB_NAME=treasuremap docker compose -p gwtm exec -T db psql -U treasuremap -d treasuremap < tests/test-data.sql
        
    - name: Verify test data loaded
      run: |
        echo "Checking if test users exist in database..."
        DB_USER=treasuremap DB_PWD=treasuremap DB_NAME=treasuremap docker compose -p gwtm exec -T db psql -U treasuremap -d treasuremap -c "SELECT COUNT(*) FROM users;" || echo "Users table query failed"
        echo "Checking if test tokens exist..."
        DB_USER=treasuremap DB_PWD=treasuremap DB_NAME=treasuremap docker compose -p gwtm exec -T db psql -U treasuremap -d treasuremap -c "SELECT username, api_token FROM users LIMIT 3;" || echo "API token query failed"
        
    - name: Test API authentication
      run: |
        echo "Testing API authentication with test token..."
        curl -f -H "api_token: test_token_admin_001" http://localhost:8000/api/v1/pointings | head -5 || echo "API auth test failed"
        echo "Testing health endpoint..."
        curl -f http://localhost:8000/health || echo "Health check failed"
        
    - name: Run FastAPI tests
      run: |
        python -m pytest tests/fastapi/ -v --disable-warnings
      env:
        API_BASE_URL: http://localhost:8000
        
    - name: Cleanup
      if: always()
      run: |
        docker stop fastapi-server || true
        docker rm fastapi-server || true
        DB_USER=treasuremap DB_PWD=treasuremap DB_NAME=treasuremap docker compose -p gwtm down -v